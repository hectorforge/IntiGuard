@model IntiGuard.Models.Venta
@{
    ViewData["Title"] = "Registrar Venta";
    var productos = ViewBag.Productos as IEnumerable<IntiGuard.Models.Producto>;
}

<div class="container mt-4">
    <h2 class="fw-bold text-primary mb-4">
        <i class="bi bi-bag-plus"></i> Registrar Venta
    </h2>

    <form asp-action="Create" method="post" id="ventaForm" class="card shadow-sm p-4 rounded-3">
        <!-- Usuario -->
        <div class="mb-3">
            <label class="form-label fw-bold">Id Usuario</label>
            <input asp-for="IdUsuario" class="form-control" placeholder="Ingrese ID de Usuario" />
            <span asp-validation-for="IdUsuario" class="text-danger"></span>
        </div>

        <!-- Total -->
        <div class="mb-3">
            <label class="form-label fw-bold">Total</label>
            <input asp-for="Total" class="form-control" id="totalVenta" readonly />
        </div>

        <hr class="my-4" />

        <h4 class="mb-3">Detalles de la Venta</h4>

        <!-- Selector de productos -->
        <div class="row g-2 mb-3 align-items-center">
            <div class="col-md-6">
                <select id="productoSelect" class="form-select">
                    <option value="">Seleccione un producto</option>
                    @foreach (var p in productos)
                    {
                        <option value="@p.IdProducto" data-precio="@p.Precio">
                            @p.NombreProducto (@p.Precio.ToString("C"))
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-2">
                <input type="number" id="cantidadInput" class="form-control" placeholder="Cantidad" min="1" />
            </div>

            <div class="col-md-4 d-flex gap-2">
                <button type="button" id="btnAgregar" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Agregar
                </button>

                <!-- Boton: enviar directo al carrito -->
                <form asp-action="AgregarAlCarrito" method="post" class="d-inline">
                    <input type="hidden" name="idProducto" id="idProductoHidden" />
                    <input type="hidden" name="cantidad" id="cantidadHidden" />
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-cart-plus"></i> Al Carrito
                    </button>
                </form>

                <a asp-action="Carrito" class="btn btn-warning">
                    <i class="bi bi-cart3"></i> Ver Carrito
                </a>
            </div>
        </div>

        <!-- Tabla de detalle -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="detalleTable">
                <thead class="table-light">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unit.</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="detallesInputs"></div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Guardar Venta
            </button>
            <a class="btn btn-secondary" href="@Url.Action("Index")">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let detalles = [];

        function actualizarTabla() {
            let tbody = $("#detalleTable tbody");
            tbody.empty();
            let total = 0;

            detalles.forEach((d, i) => {
                let subtotal = d.cantidad * d.precio;
                total += subtotal;

                tbody.append(`
                    <tr>
                        <td>${d.nombre}</td>
                        <td>${d.cantidad}</td>
                        <td>${d.precio.toFixed(2)}</td>
                        <td>${subtotal.toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarDetalle(${i})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });

            $("#totalVenta").val(total.toFixed(2));

            // Campos ocultos para enviar al Controller
            let hiddenInputs = "";
            detalles.forEach((d, i) => {
                hiddenInputs += `
                    <input type="hidden" name="detalles[${i}].IdProducto" value="${d.id}" />
                    <input type="hidden" name="detalles[${i}].Cantidad" value="${d.cantidad}" />
                    <input type="hidden" name="detalles[${i}].PrecioUnitario" value="${d.precio}" />
                `;
            });
            $("#detallesInputs").html(hiddenInputs);
        }

        function eliminarDetalle(index) {
            detalles.splice(index, 1);
            actualizarTabla();
        }

        $("#btnAgregar").click(function () {
            let idProducto = $("#productoSelect").val();
            let nombre = $("#productoSelect option:selected").text();
            let precio = parseFloat($("#productoSelect option:selected").data("precio"));
            let cantidad = parseInt($("#cantidadInput").val());

            if (!idProducto || cantidad <= 0) {
                alert("Seleccione un producto y una cantidad válida");
                return;
            }

            detalles.push({ id: idProducto, nombre: nombre, precio: precio, cantidad: cantidad });
            actualizarTabla();
            $("#productoSelect").val("");
            $("#cantidadInput").val("");
        });

        // Sincronizar el form oculto del carrito
        $("form[asp-action='AgregarAlCarrito']").submit(function () {
            let idProducto = $("#productoSelect").val();
            let cantidad = $("#cantidadInput").val();

            if (!idProducto || cantidad <= 0) {
                alert("Seleccione un producto y cantidad válida antes de enviarlo al carrito.");
                return false;
            }

            $("#idProductoHidden").val(idProducto);
            $("#cantidadHidden").val(cantidad);
            return true;
        });
    </script>
}